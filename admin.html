<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏° - ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Sarabun', sans-serif;
    }
    .tab-active {
      border-bottom: 3px solid #1e40af;
      color: #1e3a8a;
      background: #fcd34d;
      font-weight: 700;
    }
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.3s ease-out;
    }
    .toast {
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    /* User filter button styles */
    .user-filter {
      border: 1px solid rgba(15,23,42,0.06);
      color: #ffffff;
      font-weight: 700;
      transition: all 0.12s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }
    .user-filter:hover { transform: translateY(-1px); box-shadow: 0 8px 20px rgba(0,0,0,0.12); }
    /* Default visible colors (before hover/active) */
    #filter-all.user-filter { background: linear-gradient(90deg,#2563eb,#60a5fa); border-color: rgba(37,99,235,0.9); }
    #filter-admin.user-filter { background: linear-gradient(90deg,#10b981,#34d399); border-color: rgba(16,185,129,0.9); }
    #filter-student.user-filter { background: linear-gradient(90deg,#4b5563,#6b7280); border-color: rgba(75,85,99,0.9); }
    /* Active states (stronger) */
    #filter-all.tab-active { background: linear-gradient(90deg,#1e3a8a,#2563eb); color: white; border-color: rgba(37,99,235,0.9); }
    #filter-admin.tab-active { background: linear-gradient(90deg,#059669,#10b981); color: white; border-color: rgba(16,185,129,0.9); }
    #filter-student.tab-active { background: linear-gradient(90deg,#374151,#4b5563); color: white; border-color: rgba(75,85,99,0.9); }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #fbbf24 100%);">
  <div id="app" class="h-full w-full overflow-auto"><!-- Header -->
   <header class="shadow-lg border-b border-blue-400 sticky top-0 z-20" style="background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);">
    <div class="max-w-7xl mx-auto px-4 py-5">
     <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
       <div id="logo-container" class="h-20 w-20bg-white bg-opacity-20 backdrop-blur-sm rounded-xl flex items-center justify-center shadow-lg border border-white border-opacity-30 overflow-hidden">
        <img src="club-logo.png" alt="Logo" class="h-full w-full object-cover">
       </div>
       <div>
        <h1 id="system-title" class="text-3xl font-bold text-white drop-shadow-lg">üéØ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</h1>
        <p id="school-name" class="text-sm text-blue-100 drop-shadow mt-1">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏û‡∏£‡∏∞‡∏õ‡∏£‡∏∞‡∏ê‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢</p>
       </div>
      </div>
      <!-- Edit User Modal -->
       <div id="edit-user-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl">
         <div class="flex items-center justify-between mb-4">
          <h3 class="text-xl font-bold text-gray-800">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
          <button onclick="closeEditUserModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
         </div>
         <form id="edit-user-form" class="space-y-3" onsubmit="saveUserChanges(event)">
          <input type="hidden" id="edit-user-uid">
          <div><label class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠</label><input id="edit-user-firstname" class="w-full px-3 py-2 border rounded-lg" required></div>
          <div><label class="block text-sm font-medium text-gray-700">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input id="edit-user-lastname" class="w-full px-3 py-2 border rounded-lg"></div>
          <!-- email removed per requirement: do not use email -->
          <div class="grid grid-cols-2 gap-2">
            <div><label class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label><input id="edit-user-studentId" class="w-full px-3 py-2 border rounded-lg"></div>
            <div><label class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label><input id="edit-user-seat" class="w-full px-3 py-2 border rounded-lg"></div>
          </div>
          <div class="grid grid-cols-3 gap-2">
            <div><label class="block text-sm font-medium text-gray-700">‡∏ä‡∏±‡πâ‡∏ô</label><input id="edit-user-level" class="w-full px-3 py-2 border rounded-lg"></div>
            <div><label class="block text-sm font-medium text-gray-700">‡∏´‡πâ‡∏≠‡∏á</label><input id="edit-user-room" class="w-full px-3 py-2 border rounded-lg"></div>
            <div><label class="block text-sm font-medium text-gray-700">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
              <select id="edit-user-role" class="w-full px-3 py-2 border rounded-lg">
                <option value="student">student</option>
                <option value="admin">admin</option>
              </select>
            </div>
          </div>
          <div class="flex gap-2 justify-end pt-3">
            <button type="button" onclick="closeEditUserModal()" class="px-4 py-2 border rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </div>
         </form>
        </div>
       </div>
      <div class="flex items-center gap-3"><button onclick="openProfile()" class="px-4 py-2 bg-white bg-opacity-25 backdrop-blur-md text-white rounded-full text-sm font-semibold shadow-lg border border-white border-opacity-30 hover:bg-opacity-35 transition-all"> üë§ ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô </button> <button onclick="logout()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-full text-sm font-semibold shadow-lg transition-colors"> üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö </button>
      </div>
     </div>
    </div>
   </header><!-- Navigation Tabs -->
   <nav class="shadow-md sticky top-[81px] z-10" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);">
    <div class="max-w-7xl mx-auto px-4">
    <div class="flex gap-1"><button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn tab-active px-6 py-4 font-semibold text-white hover:bg-yellow-600 hover:bg-opacity-30 transition-all rounded-t-lg"> üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î </button> <button onclick="switchTab('clubs')" id="tab-clubs" class="tab-btn px-6 py-4 font-semibold text-white hover:bg-yellow-600 hover:bg-opacity-30 transition-all rounded-t-lg"> üéØ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏° </button> <button onclick="switchTab('registrations')" id="tab-registrations" class="tab-btn px-6 py-4 font-semibold text-white hover:bg-yellow-600 hover:bg-opacity-30 transition-all rounded-t-lg"> üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£ </button> <button onclick="switchTab('users')" id="tab-users" class="tab-btn px-6 py-4 font-semibold text-white hover:bg-yellow-600 hover:bg-opacity-30 transition-all rounded-t-lg"> üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ </button>
     </div>
    </div>
   </nav><!-- Main Content -->
   <main class="max-w-7xl mx-auto px-4 py-6"><!-- Dashboard Tab -->
    <div id="content-dashboard" class="tab-content fade-in">
     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <div class="bg-gradient-to-br from-yellow-400 to-yellow-500 rounded-2xl p-6 shadow-xl card-hover transition-all text-white">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-yellow-50 text-sm font-medium">‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
         <p id="stat-clubs" class="text-4xl font-bold mt-2">0</p>
        </div>
        <div class="w-14 h-14 bg-white bg-opacity-20 backdrop-blur-sm rounded-2xl flex items-center justify-center text-3xl">
         üéØ
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 card-hover transition-all">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß</p>
         <p id="stat-total-students" class="text-3xl font-bold text-blue-600">0</p>
        </div>
        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-2xl">
         üë®‚Äçüéì
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 card-hover transition-all">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</p>
         <p id="stat-registered" class="text-3xl font-bold text-green-600">0</p>
        </div>
        <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-2xl">
         ‚úÖ
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 card-hover transition-all">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°‡∏ß‡πà‡∏≤‡∏á</p>
         <p id="stat-available" class="text-3xl font-bold text-teal-600">0</p>
        </div>
        <div class="w-12 h-12 bg-teal-100 rounded-xl flex items-center justify-center text-2xl">
         üí∫
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-100 card-hover transition-all">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-500 text-sm">‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°‡πÄ‡∏ï‡πá‡∏°</p>
         <p id="stat-full" class="text-3xl font-bold text-red-600">0</p>
        </div>
        <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center text-2xl">
         üö´
        </div>
       </div>
      </div>
     </div><!-- Club Comparison Chart -->
     <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</h3>
      <div id="club-summary" class="space-y-3">
       <p class="text-gray-500 text-center py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</p>
      </div>
     </div>
    </div><!-- Clubs Management Tab -->
    <div id="content-clubs" class="tab-content hidden fade-in">
     <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 mb-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°‡πÉ‡∏´‡∏°‡πà</h3>
      <form id="add-club-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
       <div><label for="club-code" class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏° *</label> <input type="text" id="club-code" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô C001">
       </div>
       <div><label for="club-name" class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏° *</label> <input type="text" id="club-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°‡∏î‡∏ô‡∏ï‡∏£‡∏µ">
       </div>
       <div class="md:col-span-2"><label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ *</label>
        <div id="teachers-container" class="space-y-2">
         <div class="flex gap-2"><input type="text" class="teacher-input flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠.‡∏™‡∏°‡∏ä‡∏≤‡∏¢" required>
         </div>
        </div><button type="button" onclick="addTeacherField()" class="mt-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors font-medium text-sm"> ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ </button>
       </div>
      <div><label for="club-category" class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ß‡∏¥‡∏ä‡∏≤ *</label> <select id="club-category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"> <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option> <option value="‡∏Ñ‡∏ì‡∏¥‡∏ï">‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option> <option value="‡∏ß‡∏¥‡∏ó‡∏¢‡πå">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option> <option value="‡∏†‡∏≤‡∏©‡∏≤">‡∏†‡∏≤‡∏©‡∏≤</option> <option value="‡∏®‡∏¥‡∏•‡∏õ‡∏∞&‡∏î‡∏ô‡∏ï‡∏£‡∏µ">‡∏®‡∏¥‡∏•‡∏õ‡∏∞&‡∏î‡∏ô‡∏ï‡∏£‡∏µ</option> <option value="‡∏™‡∏±‡∏á‡∏Ñ‡∏°">‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option> <option value="‡∏û‡∏•‡∏∞">‡∏û‡∏•‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option> <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option> </select>
       </div>
       <div><label for="club-max" class="block text-sm font-medium text-gray-700 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î *</label> <input type="number" id="club-max" required min="1" max="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="30">
       </div>
       <div class="md:col-span-2"><label for="club-desc" class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label> <input type="text" id="club-desc" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°">
       </div>
       <div class="md:col-span-2"><button type="submit" id="add-club-btn" class="w-full md:w-auto px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all font-semibold shadow-lg"> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏° </button>
       </div>
      </form>
     </div>
     <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</h3>
      <div id="clubs-list" class="space-y-3">
       <p class="text-gray-500 text-center py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°‡πÉ‡∏´‡∏°‡πà</p>
      </div>
     </div>
    </div><!-- Registrations Tab -->
    <div id="content-registrations" class="tab-content hidden fade-in"><!-- Filter -->
     <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-4">
      <div class="flex flex-wrap items-center gap-4"><label for="filter-club" class="text-sm font-medium text-gray-700">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°:</label> <select id="filter-club" onchange="filterRegistrations()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"> <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option> </select> <input type="text" id="search-student" onkeyup="filterRegistrations()" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß..." class="flex-1 min-w-[200px] px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
      </div>
     </div>
     <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
      <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
       <h3 class="text-lg font-semibold text-gray-800">üìù ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h3>
      <div class="flex items-center gap-2 flex-wrap"><span id="registration-count" class="text-sm text-gray-500">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
      </div>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full">
        <thead>
         <tr class="bg-gray-50 text-left">
          <th class="px-4 py-3 text-sm font-semibold text-gray-600 rounded-l-lg">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th class="px-4 py-3 text-sm font-semibold text-gray-600">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
          <th class="px-4 py-3 text-sm font-semibold text-gray-600">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
          <th class="px-4 py-3 text-sm font-semibold text-gray-600">‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á</th>
          <th class="px-4 py-3 text-sm font-semibold text-gray-600">‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</th>
          <th class="px-4 py-3 text-sm font-semibold text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th>
          <th class="px-4 py-3 text-sm font-semibold text-gray-600 rounded-r-lg">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
         </tr>
        </thead>
        <tbody id="registrations-table">
         <tr>
          <td colspan="7" class="text-center py-8 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </div>
   </main><!-- Toast Container -->
   <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div><!-- Edit Club Modal -->
   <div id="edit-club-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl max-h-[90vh] overflow-y-auto">
     <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-bold text-gray-800">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</h3>
      <button onclick="closeEditClubModal()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
     </div>
     <form id="edit-club-form" class="space-y-4" onsubmit="saveClubChanges(event)">
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</label>
       <input type="text" id="edit-club-code" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°" required>
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</label>
       <input type="text" id="edit-club-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°" required>
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
       <select id="edit-club-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà --</option>
        <option value="‡∏Ñ‡∏ì‡∏¥‡∏ï">‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
        <option value="‡∏ß‡∏¥‡∏ó‡∏¢‡πå">‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
        <option value="‡∏†‡∏≤‡∏©‡∏≤">‡∏†‡∏≤‡∏©‡∏≤</option>
        <option value="‡∏™‡∏±‡∏á‡∏Ñ‡∏°">‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
        <option value="‡∏û‡∏•‡∏∞">‡∏û‡∏•‡∏∞‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
        <option value="‡∏®‡∏¥‡∏•‡∏õ‡∏∞&‡∏î‡∏ô‡∏ï‡∏£‡∏µ">‡∏®‡∏¥‡∏•‡∏õ‡∏∞&‡∏î‡∏ô‡∏ï‡∏£‡∏µ</option>
        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
       </select>
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤</label>
       <input type="text" id="edit-club-teacher" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤" required>
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
       <textarea id="edit-club-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°" required></textarea>
      </div>
      <div>
       <label class="block text-sm font-medium text-gray-700 mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</label>
       <input type="number" id="edit-club-max-members" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å" required>
      </div>
      <div class="flex gap-3 pt-4 border-t border-gray-200">
       <button type="button" onclick="closeEditClubModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
       <button type="submit" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
     </form>
    </div>
   </div><!-- Delete Confirmation Modal -->
   <div id="delete-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl">
     <h3 class="text-lg font-semibold text-gray-800 mb-2">‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
     <p id="delete-modal-text" class="text-gray-600 mb-4">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
     <div class="flex gap-3 justify-end"><button onclick="closeDeleteModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button> <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">‡∏•‡∏ö</button>
     </div>
    </div>
   </div><!-- Profile Modal -->
   <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl">
     <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-bold text-gray-800">üë§ ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3><button onclick="closeProfile()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
     </div>
     <div class="space-y-4"><!-- Profile Info -->
      <div class="bg-gradient-to-br from-indigo-50 to-blue-50 rounded-lg p-4 border border-indigo-100">
       <div class="flex items-center gap-4">
        <div class="relative">
         <div id="profile-avatar" class="w-16 h-16 bg-indigo-600 rounded-full flex items-center justify-center text-white text-2xl font-bold cursor-pointer hover:opacity-80 transition-opacity overflow-hidden" onclick="document.getElementById('avatar-input').click()">
          A
         </div>
         <div class="absolute bottom-0 right-0 w-5 h-5 bg-white rounded-full flex items-center justify-center shadow-md cursor-pointer" onclick="document.getElementById('avatar-input').click()">
          üì∑
         </div><input type="file" id="avatar-input" accept="image/*" class="hidden" onchange="handleAvatarChange(event)">
        </div>
        <div>
         <p class="font-semibold text-gray-800" id="profile-username">admin</p>
         <p class="text-sm text-gray-500">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
        </div>
       </div>
      </div><!-- Edit Profile Form -->
      <form id="profile-form" class="space-y-4">
       <div><label for="edit-username" class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label> <input type="text" id="edit-username" value="admin" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
       </div><button type="submit" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium"> üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• </button>
      </form>
      <div class="border-t border-gray-200 pt-4"><button onclick="openChangePassword()" class="w-full px-4 py-2 bg-amber-100 text-amber-700 rounded-lg hover:bg-amber-200 transition-colors font-medium"> üîê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô </button>
      </div>
     </div>
    </div>
   </div><!-- Change Password Modal -->
   <div id="password-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-2xl">
     <div class="flex items-center justify-between mb-6">
      <h3 class="text-xl font-bold text-gray-800">üîê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3><button onclick="closeChangePassword()" class="text-gray-400 hover:text-gray-600 text-2xl">√ó</button>
     </div>
     <form id="password-form" class="space-y-4">
      <div><label for="current-password" class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label> <input type="password" id="current-password" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div><label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label> <input type="password" id="new-password" required minlength="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
       <p class="text-xs text-gray-500 mt-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</p>
      </div>
      <div><label for="confirm-password" class="block text-sm font-medium text-gray-700 mb-1">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label> <input type="password" id="confirm-password" required minlength="6" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="flex gap-3"><button type="button" onclick="closeChangePassword()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å </button> <button type="submit" class="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium"> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô </button>
      </div>
     </form>
    </div>
   </div>
   <!-- Users Management Tab -->
    <div id="content-users" class="tab-content hidden fade-in">
     <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 mb-6">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
      <div class="mb-4">
        <div class="flex items-center justify-between gap-2 p-2 bg-white border border-gray-100 rounded-lg">
          <div class="flex gap-2 items-center">
            <button id="filter-all" onclick="setUserRoleFilter('all')" class="px-3 py-2 user-filter rounded-lg">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="user-count-all" class="ml-2 text-xs text-white/80">-</span></button>
            <button id="filter-admin" onclick="setUserRoleFilter('admin')" class="px-3 py-2 user-filter rounded-lg">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô <span id="user-count-admin" class="ml-2 text-xs text-white/80">-</span></button>
            <button id="filter-student" onclick="setUserRoleFilter('student')" class="px-3 py-2 user-filter rounded-lg">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <span id="user-count-student" class="ml-2 text-xs text-white/80">-</span></button>
          </div>
          <div class="flex items-center gap-2">
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 items-center">
        <div class="md:col-span-2">
          <input id="user-search" type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡∏ä‡∏∑‡πà‡∏≠, ‡∏≠‡∏µ‡πÄ‡∏°‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß" oninput="renderUsersList()" class="w-full px-4 py-2 border border-gray-300 rounded-lg" />
        </div>
      </div>

      

      <div id="users-list" class="space-y-3 max-h-[40vh] overflow-y-auto">
        <p class="text-gray-500 text-center py-8">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ...</p>
      </div>
     </div>
    </div>
  </div>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCmDBt1LJLWUEljGQVjYcaJ5FJRm9pcM_k",
      authDomain: "wedappis.firebaseapp.com",
      databaseURL: "https://wedappis-default-rtdb.firebaseio.com",
      projectId: "wedappis",
      storageBucket: "wedappis.firebasestorage.app",
      messagingSenderId: "838403173250",
      appId: "1:838403173250:web:1f5fc5786c6c1104c4bd9b",
      measurementId: "G-F73HSEZBBW"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Application state
    let clubs = [];
    let registrations = [];
    let pendingDelete = null;
    let isLoading = false;
    let roleChecked = false;
    // Current users filter: 'all' | 'admin' | 'student'
    window.__user_role_filter = 'all';

    // Check Admin Role
    function checkAdminAccess() {
      if (roleChecked) return;
      
      auth.onAuthStateChanged((user) => {
        if (!user) {
          roleChecked = true;
          Swal.fire({
            icon: 'warning',
            title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
            text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤ Admin',
            confirmButtonColor: '#6d83f2',
            allowOutsideClick: false,
            allowEscapeKey: false
          }).then(() => {
            window.location.href = 'index.html';
          });
          return;
        }

        db.ref('users/' + user.uid).once('value').then((snapshot) => {
          const userData = snapshot.val();
          roleChecked = true;
          
          if (!userData || userData.role !== 'admin') {
            Swal.fire({
              icon: 'error',
              title: '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á',
              text: '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤ Admin (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)',
              confirmButtonColor: '#6d83f2',
              allowOutsideClick: false,
              allowEscapeKey: false
            }).then(() => {
              window.location.href = 'index.html';
            });
            return;
          }

          console.log('Admin access granted for:', userData.firstname);
          loadAllData();
        }).catch((error) => {
          console.error('Error checking role:', error);
          if (!roleChecked) {
            roleChecked = true;
            window.location.href = 'index.html';
          }
        });
      });
    }

    // Load all data from Firebase
    function loadAllData() {
      db.ref('clubs').on('value', (snapshot) => {
        clubs = [];
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            clubs.push({
              __backendId: childSnapshot.key,
              ...childSnapshot.val()
            });
          });
        }
        console.log('Clubs loaded:', clubs.length);
        updateDashboard();
        renderClubsList();
        updateClubSelects();
      });

      db.ref('registrations').on('value', (snapshot) => {
        registrations = [];
        if (snapshot.exists()) {
          snapshot.forEach((childSnapshot) => {
            registrations.push({
              __backendId: childSnapshot.key,
              ...childSnapshot.val()
            });
          });
        }
        console.log('Registrations loaded:', registrations.length);
        updateDashboard();
        renderRegistrationsTable();
        updateClubSelects();
      });

      // Load users
      db.ref('users').on('value', (snapshot) => {
        const users = [];
        if (snapshot.exists()) {
          snapshot.forEach((child) => {
            users.push({ uid: child.key, ...child.val() });
          });
        }
        window.__admin_users = users; // store globally for rendering
        renderUsersList();
        console.log('Users loaded:', users.length);
      });
    }

    // CSV Export Function
    function escapeCSV(value) {
      if (value === null || value === undefined) return '';
      const str = String(value);
      if (str.includes(',') || str.includes('"') || str.includes('\n')) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    }

    function downloadCSV(filename, csvContent) {
      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function exportAllRegistrations() {
      if (registrations.length === 0) {
        showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡πâ Export', 'error');
        return;
      }

      const headers = ['‡∏•‡∏≥‡∏î‡∏±‡∏ö', '‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß', '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', '‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á', '‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°', '‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°', '‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà', '‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£'];
      let csv = headers.join(',') + '\n';

      registrations.forEach((reg, index) => {
        const club = clubs.find(c => c.__backendId === reg.club_id);
        const date = reg.registered_at ? new Date(reg.registered_at).toLocaleDateString('th-TH') : '-';
        
        const row = [
          index + 1,
          escapeCSV(reg.student_id || '-'),
          escapeCSV(reg.student_name || '-'),
          escapeCSV(reg.student_class || '-'),
          escapeCSV(club?.club_code || '-'),
          escapeCSV(club?.name || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°'),
          escapeCSV(club?.category || '-'),
          escapeCSV(club?.teacher || '-'),
          escapeCSV(date)
        ];
        
        csv += row.join(',') + '\n';
      });

      const timestamp = new Date().toISOString().slice(0, 10);
      downloadCSV(`‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î_${timestamp}.csv`, csv);
      showToast('Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üì•', 'success');
    }

    // Export members of a single club as CSV
    function exportClub(clubId) {
      const club = clubs.find(c => c.__backendId === clubId);
      if (!club) {
        showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°', 'error');
        return;
      }

      const members = registrations.filter(r => r.club_id === clubId);
      if (members.length === 0) {
        showToast('‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å', 'error');
        return;
      }

      const headers = ['‡∏•‡∏≥‡∏î‡∏±‡∏ö', '‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß', '‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•', '‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£'];
      let csv = `‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°: ${club.name} (${club.club_code || ''})\n`;
      csv += `‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: ${club.category || '-'}\n`;
      csv += `‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤: ${club.teacher || '-'}\n`;
      csv += `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: ${members.length}/${club.max_members || 30}\n\n`;
      csv += headers.join(',') + '\n';

      members.forEach((member, idx) => {
        const date = member.registered_at ? new Date(member.registered_at).toLocaleDateString('th-TH') : '-';
        const row = [
          idx + 1,
          escapeCSV(member.student_id || '-'),
          escapeCSV(member.student_name || '-'),
          escapeCSV(member.student_class || '-'),
          escapeCSV(date)
        ];
        csv += row.join(',') + '\n';
      });

      const timestamp = new Date().toISOString().slice(0,10);
      const filename = `${club.name.replace(/\s+/g,'_') || 'club'}_${club.club_code || ''}_${timestamp}.csv`;
      downloadCSV(filename, csv);
      showToast('Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üì•', 'success');
    }

    // Tab switching
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
      
      document.getElementById(`tab-${tab}`).classList.add('tab-active');
      document.getElementById(`content-${tab}`).classList.remove('hidden');
    }

    // Add teacher field
    function addTeacherField() {
      const container = document.getElementById('teachers-container');
      const fieldCount = container.querySelectorAll('.teacher-input').length;
      
      if (fieldCount >= 5) {
        showToast('‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 5 ‡∏Ñ‡∏ô', 'error');
        return;
      }
      
      const newField = document.createElement('div');
      newField.className = 'flex gap-2';
      newField.innerHTML = `
        <input type="text" class="teacher-input flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠.‡∏™‡∏°‡∏ä‡∏≤‡∏¢">
        <button type="button" onclick="this.parentElement.remove()" class="px-3 py-2 text-red-500 hover:bg-red-100 rounded-lg transition-colors">
          üóëÔ∏è
        </button>
      `;
      container.appendChild(newField);
    }

    // Update dashboard
    function updateDashboard() {
      const totalClubs = clubs.length;
      const registeredStudents = registrations.length;
      
      let availableClubs = 0;
      let fullClubs = 0;
      
      clubs.forEach(club => {
        const memberCount = registrations.filter(r => r.club_id === club.__backendId).length;
        const available = (club.max_members || 30) - memberCount;
        if (available > 0) availableClubs++;
        else fullClubs++;
      });

      document.getElementById('stat-clubs').textContent = totalClubs;
      document.getElementById('stat-total-students').textContent = registeredStudents;
      document.getElementById('stat-registered').textContent = registeredStudents;
      document.getElementById('stat-available').textContent = availableClubs;
      document.getElementById('stat-full').textContent = fullClubs;

      const summaryContainer = document.getElementById('club-summary');
      if (clubs.length === 0) {
        summaryContainer.innerHTML = '<p class="text-gray-500 text-center py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</p>';
      } else {
        const maxPossible = Math.max(...clubs.map(c => c.max_members || 30));
        
        summaryContainer.innerHTML = `
          <div class="space-y-4">
            ${clubs.map(club => {
              const memberCount = registrations.filter(r => r.club_id === club.__backendId).length;
              const maxMembers = club.max_members || 30;
              const percentage = Math.round((memberCount / maxMembers) * 100);
              const barWidth = Math.round((memberCount / maxPossible) * 100);
              const maxBarWidth = Math.round((maxMembers / maxPossible) * 100);
              
              return `
                <div class="space-y-2">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                      <span class="px-2 py-0.5 bg-indigo-600 text-white rounded text-xs font-semibold">${club.club_code || 'N/A'}</span>
                      <p class="font-medium text-gray-800">${club.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</p>
                    </div>
                    <span class="text-sm font-semibold ${percentage >= 100 ? 'text-red-600' : percentage >= 80 ? 'text-amber-600' : 'text-green-600'}">${memberCount}/${maxMembers} (${percentage}%)</span>
                  </div>
                  <div class="relative h-10 bg-gray-100 rounded-lg overflow-hidden">
                    <div class="absolute h-full bg-gray-200 rounded-lg transition-all" style="width: ${maxBarWidth}%"></div>
                    <div class="absolute h-full ${percentage >= 100 ? 'bg-red-500' : percentage >= 80 ? 'bg-amber-500' : 'bg-green-500'} rounded-lg transition-all flex items-center justify-end pr-2" style="width: ${barWidth}%">
                      ${barWidth > 15 ? `<span class="text-white text-sm font-semibold">${memberCount}</span>` : ''}
                    </div>
                    ${barWidth <= 15 && memberCount > 0 ? `<span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-700 text-sm font-semibold">${memberCount}</span>` : ''}
                  </div>
                  <p class="text-xs text-gray-500">üë®‚Äçüè´ ${club.teacher || '-'}</p>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }
    }

    // Render clubs list
    function renderClubsList() {
      const container = document.getElementById('clubs-list');
      
      if (clubs.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°‡πÉ‡∏´‡∏°‡πà</p>';
        return;
      }

      container.innerHTML = clubs.map((club, index) => {
        const memberCount = registrations.filter(r => r.club_id === club.__backendId).length;
        const maxMembers = club.max_members || 30;
        
        return `
          <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
            <div class="w-16 h-16 bg-indigo-100 rounded-lg flex items-center justify-center font-bold text-indigo-600">${index + 1}</div>
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <span class="px-2 py-0.5 bg-indigo-600 text-white rounded text-xs font-semibold">${club.club_code || 'N/A'}</span>
                <p class="font-semibold text-gray-800">${club.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</p>
              </div>
              <p class="text-sm text-gray-500">üë®‚Äçüè´ ${club.teacher || '-'} | ${club.description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</p>
            </div>
            <div class="text-center px-4">
              <p class="text-lg font-bold ${memberCount >= maxMembers ? 'text-red-600' : 'text-green-600'}">${memberCount}/${maxMembers}</p>
              <p class="text-xs text-gray-500">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</p>
            </div>
            <div class="flex gap-2">
              <button onclick="editClubForm('${club.__backendId}')" class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°">
                ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
              </button>
              <button onclick="exportClub('${club.__backendId}')" class="p-2 text-green-600 hover:bg-green-100 rounded-lg transition-colors" title="Export ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠">
                üì• Export
              </button>
              <button onclick="confirmDeleteClub('${club.__backendId}')" class="p-2 text-red-500 hover:bg-red-100 rounded-lg transition-colors" title="‡∏•‡∏ö‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°">
                üóëÔ∏è ‡∏•‡∏ö
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Render registrations table
    function renderRegistrationsTable() {
      const filterClub = document.getElementById('filter-club').value;
      const searchTerm = document.getElementById('search-student').value.toLowerCase();
      
      let filtered = registrations;
      
      if (filterClub) {
        filtered = filtered.filter(r => r.club_id === filterClub);
      }
      
      if (searchTerm) {
        filtered = filtered.filter(r => 
          (r.student_name || '').toLowerCase().includes(searchTerm) ||
          (r.student_id || '').toLowerCase().includes(searchTerm)
        );
      }

      document.getElementById('registration-count').textContent = `${filtered.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

      const tbody = document.getElementById('registrations-table');
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map((reg, index) => {
        const club = clubs.find(c => c.__backendId === reg.club_id);
        const date = reg.registered_at ? new Date(reg.registered_at).toLocaleDateString('th-TH') : '-';
        
        return `
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="px-4 py-3 text-gray-600">${index + 1}</td>
            <td class="px-4 py-3 font-medium text-gray-800">${reg.student_id || '-'}</td>
            <td class="px-4 py-3 text-gray-800">${reg.student_name || '-'}</td>
            <td class="px-4 py-3 text-gray-600">${reg.student_class || '-'}</td>
            <td class="px-4 py-3">
              <span class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm">${club?.name || '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°'}</span>
            </td>
            <td class="px-4 py-3 text-gray-500 text-sm">${date}</td>
            <td class="px-4 py-3">
              <button onclick="confirmDeleteRegistration('${reg.__backendId}')" class="p-1 text-red-500 hover:bg-red-100 rounded transition-colors" title="‡∏•‡∏ö">
                üóëÔ∏è
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Update club selects
    function updateClubSelects() {
      const options = clubs.map(club => {
        const memberCount = registrations.filter(r => r.club_id === club.__backendId).length;
        const maxMembers = club.max_members || 30;
        const isFull = memberCount >= maxMembers;
        
        return `<option value="${club.__backendId}" ${isFull ? 'disabled' : ''}>${club.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'} (${memberCount}/${maxMembers})${isFull ? ' - ‡πÄ‡∏ï‡πá‡∏°' : ''}</option>`;
      }).join('');

      document.getElementById('filter-club').innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>' + options;
    }

    // Users management functions
    // NOTE: realtime listener in loadAllData() already updates users; no manual refresh needed.

    function renderUsersList() {
      const container = document.getElementById('users-list');
      const q = (document.getElementById('user-search')?.value || '').toLowerCase();
      const users = window.__admin_users || [];

      // Compute counts
      const totalCount = users.length;
      const adminCount = users.filter(u => (u.role || 'student') === 'admin').length;
      const studentCount = users.filter(u => (u.role || 'student') !== 'admin').length;
      // Update count badges
      const elAll = document.getElementById('user-count-all');
      const elAdmin = document.getElementById('user-count-admin');
      const elStudent = document.getElementById('user-count-student');
      if (elAll) elAll.textContent = totalCount;
      if (elAdmin) elAdmin.textContent = adminCount;
      if (elStudent) elStudent.textContent = studentCount;

      // Apply search
      let filtered = users.filter(u => {
        if (!q) return true;
        const v = `${u.firstname || ''} ${u.lastname || ''} ${u.studentId || ''} ${u.level || ''} ${u.room || ''}`.toLowerCase();
        return v.includes(q);
      });

      // Apply role filter
      const roleFilter = window.__user_role_filter || 'all';
      if (roleFilter === 'admin') {
        filtered = filtered.filter(u => (u.role || 'student') === 'admin');
      } else if (roleFilter === 'student') {
        filtered = filtered.filter(u => (u.role || 'student') !== 'admin');
      }

      // Update filter button styles
      ['all','admin','student'].forEach(r => {
        const btn = document.getElementById('filter-' + r);
        if (!btn) return;
        if (r === roleFilter) {
          btn.classList.add('tab-active');
        } else {
          btn.classList.remove('tab-active');
        }
      });

      if (filtered.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>';
        return;
      }

      container.innerHTML = filtered.map(u => {
        const role = u.role || 'student';
        const name = `${u.firstname || ''} ${u.lastname || ''}`.trim() || (u.studentId || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏');
        const studentId = u.studentId || u.student_id || '-';
        const classRoom = (u.level && u.room) ? `${u.level}/${u.room}` : (u.student_class || '-');
        const seat = u.seat || u.number || u.no || '-';

        return `
          <div class="flex items-center justify-between gap-4 p-3 bg-gray-50 rounded-lg">
            <div>
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-semibold">${escapeHtml((u.firstname||'').charAt(0) || 'U')}</div>
                <div>
                  <p class="font-semibold text-gray-800">${escapeHtml(name)}</p>
                  <p class="text-xs text-gray-500">‡∏£‡∏´‡∏±‡∏™: ${escapeHtml(studentId)} ‚Ä¢ ‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á: ${escapeHtml(classRoom)} ‚Ä¢ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${escapeHtml(seat)}</p>
                </div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="px-3 py-1 rounded-full text-sm ${role === 'admin' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'}">${escapeHtml(role)}</span>
              ${role === 'admin' ? `<button onclick="demoteUser('${u.uid}')" class="px-3 py-1 bg-red-500 text-white rounded-lg">‡∏ñ‡∏≠‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</button>` : `<button onclick="promoteUser('${u.uid}')" class="px-3 py-1 bg-amber-500 text-white rounded-lg">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πá‡∏ô Admin</button>`}
              <button onclick="openEditUserModal('${u.uid}')" class="px-3 py-1 bg-blue-600 text-white rounded-lg">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button onclick="deleteUser('${u.uid}')" class="px-3 py-1 bg-red-600 text-white rounded-lg">‡∏•‡∏ö</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function setUserRoleFilter(role) {
      window.__user_role_filter = role || 'all';
      renderUsersList();
    }

    function escapeHtml(str) {
      return String(str||'').replace(/[&<>"]+/g, function(s){
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'})[s];
      });
    }

    function promoteUser(uid) {
      const user = (window.__admin_users || []).find(u => u.uid === uid);
      if (!user) return showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'error');

      Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
        text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î ${user.firstname || user.studentId || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'} ‡πÄ‡∏õ‡πá‡∏ô Admin ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏Å‡∏≥‡∏´‡∏ô‡∏î',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      }).then(async (res) => {
        if (!res.isConfirmed) return;
        try {
          await db.ref('users/' + uid).update({ role: 'admin' });
          showToast('‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        } catch (err) {
          console.error('promote error', err);
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏î‡πâ', 'error');
        }
      });
    }

    function demoteUser(uid) {
      const user = (window.__admin_users || []).find(u => u.uid === uid);
      if (!user) return showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'error');

      Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
        text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏≠‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ‡∏Ç‡∏≠‡∏á ${user.firstname || user.studentId || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏ñ‡∏≠‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      }).then(async (res) => {
        if (!res.isConfirmed) return;
        try {
          await db.ref('users/' + uid).update({ role: 'student' });
          showToast('‡∏ñ‡∏≠‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        } catch (err) {
          console.error('demote error', err);
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ñ‡∏≠‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏î‡πâ', 'error');
        }
      });
    }

    async function makeAdminByIdentifier(e) {
      e.preventDefault();
      const val = document.getElementById('make-admin-input').value.trim();
      if (!val) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß', 'error');

      const users = window.__admin_users || [];
      const found = users.find(u => (u.studentId && u.studentId.toLowerCase() === val.toLowerCase()) || (u.student_id && u.student_id.toLowerCase() === val.toLowerCase()));
      if (!found) return showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏', 'error');

      try {
        await db.ref('users/' + found.uid).update({ role: 'admin' });
        showToast('‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        document.getElementById('make-admin-input').value = '';
      } catch (err) {
        console.error('makeAdmin error', err);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏î‡πâ', 'error');
      }
    }

    // Edit user modal handlers
    let currentEditingUserId = null;
    function openEditUserModal(uid) {
      const user = (window.__admin_users || []).find(u => u.uid === uid);
      if (!user) return showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'error');
      currentEditingUserId = uid;
      document.getElementById('edit-user-uid').value = uid;
      document.getElementById('edit-user-firstname').value = user.firstname || '';
      document.getElementById('edit-user-lastname').value = user.lastname || '';
      // email not used
      document.getElementById('edit-user-studentId').value = user.studentId || user.student_id || '';
      document.getElementById('edit-user-level').value = user.level || '';
      document.getElementById('edit-user-room').value = user.room || '';
      document.getElementById('edit-user-seat').value = user.seat || user.number || user.no || '';
      document.getElementById('edit-user-role').value = user.role || 'student';
      document.getElementById('edit-user-modal').classList.remove('hidden');
    }

    function closeEditUserModal() {
      currentEditingUserId = null;
      document.getElementById('edit-user-modal').classList.add('hidden');
    }

    async function saveUserChanges(e) {
      e.preventDefault();
      if (!currentEditingUserId) return;
      const uid = currentEditingUserId;
      const updates = {
        firstname: document.getElementById('edit-user-firstname').value.trim(),
        lastname: document.getElementById('edit-user-lastname').value.trim(),
        // email removed from updates
        studentId: document.getElementById('edit-user-studentId').value.trim(),
        level: document.getElementById('edit-user-level').value.trim(),
        room: document.getElementById('edit-user-room').value.trim(),
        seat: document.getElementById('edit-user-seat').value.trim(),
        role: document.getElementById('edit-user-role').value
      };

      try {
        await db.ref('users/' + uid).update(updates);
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        closeEditUserModal();
      } catch (err) {
        console.error('saveUserChanges error', err);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
      }
    }

    async function deleteUser(uid) {
      const user = (window.__admin_users || []).find(u => u.uid === uid);
      if (!user) return showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'error');

      Swal.fire({
        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
        text: `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á ${user.firstname || user.studentId || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
      }).then(async (res) => {
        if (!res.isConfirmed) return;
        try {
          // Remove related registrations by matching studentId if available
          const studentId = user.studentId || user.student_id || null;
          if (studentId) {
            const regs = registrations.filter(r => (r.student_id || '').toString() === studentId.toString());
            for (const r of regs) {
              if (r.__backendId) await db.ref('registrations/' + r.__backendId).remove();
            }
          }

          // Remove user node (note: does NOT delete from Firebase Auth)
          await db.ref('users/' + uid).remove();
          showToast('‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
        } catch (err) {
          console.error('deleteUser error', err);
          showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏î‡πâ', 'error');
        }
      });
    }

    // Filter registrations
    function filterRegistrations() {
      renderRegistrationsTable();
    }

    // Add club form
    document.getElementById('add-club-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (isLoading) return;

      const clubCode = document.getElementById('club-code').value.trim();
      const name = document.getElementById('club-name').value.trim();
      const category = document.getElementById('club-category').value;
      
      const teacherInputs = document.querySelectorAll('.teacher-input');
      const teachers = Array.from(teacherInputs)
        .map(input => input.value.trim())
        .filter(t => t !== '');
      
      const maxMembers = parseInt(document.getElementById('club-max').value) || 30;
      const description = document.getElementById('club-desc').value.trim();

      if (!clubCode || !name || !category || teachers.length === 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
        return;
      }

      const codeExists = clubs.find(c => c.club_code === clubCode);
      if (codeExists) {
        showToast('‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error');
        return;
      }

      isLoading = true;
      const btn = document.getElementById('add-club-btn');
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°...';

      try {
        await db.ref('clubs').push().set({
          type: 'club',
          club_code: clubCode,
          name: name,
          category: category,
          teacher: teachers.join(', '),
          max_members: maxMembers,
          description: description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î',
          created_at: firebase.database.ServerValue.TIMESTAMP
        });

        showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úì', 'success');
        document.getElementById('add-club-form').reset();
        document.getElementById('teachers-container').innerHTML = `
          <div class="flex gap-2">
            <input type="text" class="teacher-input flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠.‡∏™‡∏°‡∏ä‡∏≤‡∏¢" required>
          </div>
        `;
      } catch (error) {
        console.error('Error adding club:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      }

      isLoading = false;
      btn.disabled = false;
      btn.textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°';
    });

    // Delete functions
    function confirmDeleteClub(id) {
      const club = clubs.find(c => c.__backendId === id);
      const memberCount = registrations.filter(r => r.club_id === id).length;
      
      document.getElementById('delete-modal-text').textContent = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏° "${club?.name || ''}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ${memberCount > 0 ? `(‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${memberCount} ‡∏Ñ‡∏ô ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢)` : ''}`;
      document.getElementById('delete-modal').classList.remove('hidden');
      
      pendingDelete = { type: 'club', id };
    }

    // Edit club functions
    let currentEditingClubId = null;

    function editClubForm(clubId) {
      const club = clubs.find(c => c.__backendId === clubId);
      if (!club) return;

      currentEditingClubId = clubId;
      document.getElementById('edit-club-code').value = club.club_code || '';
      document.getElementById('edit-club-name').value = club.name || '';
      document.getElementById('edit-club-category').value = club.category || '';
      document.getElementById('edit-club-teacher').value = club.teacher || '';
      document.getElementById('edit-club-description').value = club.description || '';
      document.getElementById('edit-club-max-members').value = club.max_members || 30;

      document.getElementById('edit-club-modal').classList.remove('hidden');
    }

    function closeEditClubModal() {
      document.getElementById('edit-club-modal').classList.add('hidden');
      currentEditingClubId = null;
    }

    async function saveClubChanges(e) {
      e.preventDefault();
      if (!currentEditingClubId) return;

      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      try {
        await db.ref('clubs/' + currentEditingClubId).update({
          club_code: document.getElementById('edit-club-code').value,
          name: document.getElementById('edit-club-name').value,
          category: document.getElementById('edit-club-category').value,
          teacher: document.getElementById('edit-club-teacher').value,
          description: document.getElementById('edit-club-description').value,
          max_members: parseInt(document.getElementById('edit-club-max-members').value)
        });

        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úì', 'success');
        closeEditClubModal();
      } catch (error) {
        console.error('Error saving club:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      }

      btn.disabled = false;
      btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
    }

    function confirmDeleteRegistration(id) {
      const reg = registrations.find(r => r.__backendId === id);
      
      document.getElementById('delete-modal-text').textContent = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á "${reg?.student_name || ''}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`;
      document.getElementById('delete-modal').classList.remove('hidden');
      
      pendingDelete = { type: 'registration', id };
    }

    function closeDeleteModal() {
      document.getElementById('delete-modal').classList.add('hidden');
      pendingDelete = null;
    }

    document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
      if (!pendingDelete || isLoading) return;

      isLoading = true;
      const btn = document.getElementById('confirm-delete-btn');
      btn.disabled = true;
      btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...';

      try {
        if (pendingDelete.type === 'club') {
          const club = clubs.find(c => c.__backendId === pendingDelete.id);
          if (club) {
            const clubRegistrations = registrations.filter(r => r.club_id === pendingDelete.id);
            for (const reg of clubRegistrations) {
              await db.ref('registrations/' + reg.__backendId).remove();
            }
            await db.ref('clubs/' + pendingDelete.id).remove();
          }
        } else if (pendingDelete.type === 'registration') {
          await db.ref('registrations/' + pendingDelete.id).remove();
        }

        showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      } catch (error) {
        console.error('Error deleting:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
      }

      isLoading = false;
      btn.disabled = false;
      btn.textContent = '‡∏•‡∏ö';
      
      closeDeleteModal();
    });

    // Toast notification
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-indigo-500';
      const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚Ñπ';
      
      toast.className = `toast ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2`;
      toast.innerHTML = `<span class="font-bold">${icon}</span> ${message}`;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        toast.style.transition = 'all 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Profile management
    function openProfile() {
      const user = auth.currentUser;
      if (!user) {
        Swal.fire({
          icon: 'warning',
          title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö',
          text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå',
          confirmButtonColor: '#6d83f2'
        }).then(() => window.location.href = 'index.html');
        return;
      }

      // Load profile from DB if available
      db.ref('users/' + user.uid).once('value').then((snap) => {
        const data = snap.val() || {};
        const username = data.firstname ? (data.firstname + (data.lastname ? ' ' + data.lastname : '')) : (data.username || user.displayName || 'admin');
        document.getElementById('profile-username').textContent = username;
        document.getElementById('edit-username').value = username;

        const avatarEl = document.getElementById('profile-avatar');
        if (data.avatar) {
          avatarEl.style.backgroundImage = `url(${data.avatar})`;
          avatarEl.style.backgroundSize = 'cover';
          avatarEl.style.backgroundPosition = 'center';
          avatarEl.textContent = '';
        }
      }).catch((err) => {
        console.error('Load profile error:', err);
      }).finally(() => {
        document.getElementById('profile-modal').classList.remove('hidden');
      });
    }

    function closeProfile() {
      document.getElementById('profile-modal').classList.add('hidden');
    }

    function handleAvatarChange(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file size (max 2MB) and type (image/*)
      if (file.size > 2 * 1024 * 1024) {
        showToast('‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 2MB', 'error');
        return;
      }

      if (!file.type || !file.type.startsWith('image/')) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠ GIF ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = async function(e) {
        const dataUrl = e.target.result;
        const avatarEl = document.getElementById('profile-avatar');
        avatarEl.style.backgroundImage = `url(${dataUrl})`;
        avatarEl.style.backgroundSize = 'cover';
        avatarEl.style.backgroundPosition = 'center';
        avatarEl.textContent = '';

        // Save avatar data URL to user's DB (simple approach)
        const user = auth.currentUser;
        if (user) {
          try {
            await db.ref('users/' + user.uid).update({ avatar: dataUrl });
            showToast('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
          } catch (err) {
            console.error('Save avatar error:', err);
            showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ', 'error');
          }
        } else {
          showToast('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)', 'success');
        }
      };
      reader.readAsDataURL(file);
    }

    document.getElementById('profile-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const username = document.getElementById('edit-username').value.trim();
      if (!username) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'error');
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'error');
        return;
      }

      // Split into firstname / lastname (first token -> firstname, rest -> lastname)
      const parts = username.split(' ').filter(p => p !== '');
      const firstname = parts.length > 0 ? parts[0] : username;
      const lastname = parts.length > 1 ? parts.slice(1).join(' ') : '';

      try {
        await db.ref('users/' + user.uid).update({ firstname, lastname });
        try { await user.updateProfile({ displayName: username }); } catch (err) { console.warn('Auth updateProfile skipped', err); }
        document.getElementById('profile-username').textContent = username;
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        setTimeout(() => closeProfile(), 1000);
      } catch (err) {
        console.error('Save profile error:', err);
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
      }
    });

    function openChangePassword() {
      closeProfile();
      document.getElementById('password-modal').classList.remove('hidden');
    }

    function closeChangePassword() {
      document.getElementById('password-modal').classList.add('hidden');
    }

    document.getElementById('password-form')?.addEventListener('submit', (e) => {
      e.preventDefault();
      showToast('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      setTimeout(() => closeChangePassword(), 1000);
    });

    function logout() {
      Swal.fire({
        icon: 'question',
        title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö',
        text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
        showCancelButton: true,
        confirmButtonText: '‡∏≠‡∏≠‡∏Å',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
        confirmButtonColor: '#6366f1'
      }).then((result) => {
        if (result.isConfirmed) {
          auth.signOut().then(() => {
            window.location.href = 'index.html';
          });
        }
      });
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', checkAdminAccess);
    } else {
      checkAdminAccess();
    }
  </script>
 </body>
</html>
